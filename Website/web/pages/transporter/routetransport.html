<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Regions - BinXZer0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #detailMap {
            height: 250px;
            border-radius: 8px;
        }
        .region-actions { display: flex; gap: 10px; }
        .map-controls {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .map-controls .btn.active {
            background-color: #28a745;
            color: white;
        }
        .region-card { transition: transform 0.2s ease; }
        .region-card:hover { transform: translateY(-2px); }
        .notification { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .quick-link-btn {
            transition: background-color 0.3s ease;
        }
        .quick-link-btn:hover {
            background-color: #28a745;
            color: white;
        }
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            border-bottom: 1px solid #dee2e6;
        }
        .modal-footer {
            border-top: 1px solid #dee2e6;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }
        .table th {
            cursor: pointer;
        }
        .table th:hover {
            background-color: #e9ecef;
        }
        .table th.active {
            background-color: #d4edda;
        }
    </style>
</head>
<body>
    <!-- Placeholder for navigation (loaded from tranav.html) -->
    <div id="nav-placeholder"></div>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>My Assigned Regions</h1>
        </div>

        <!-- Map Container -->
        <div class="position-relative mb-4">
            <div id="map"></div>
            <div class="map-controls">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-success active" id="roadmapLayerBtn" data-bs-toggle="tooltip" title="Switch to roadmap view">
                        <i class="fas fa-road"></i> Roadmap
                    </button>
                    <button class="btn btn-sm btn-outline-success" id="satelliteLayerBtn" data-bs-toggle="tooltip" title="Switch to satellite view">
                        <i class="fas fa-satellite"></i> Satellite
                    </button>
                </div>
            </div>
        </div>

        <!-- Region Summary Cards -->
        <div class="row g-4 mb-4" id="regionSummaryCards">
            <!-- Dynamically populated -->
        </div>

        <!-- Destination Quick Links -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Quick Access Regions</h5>
                <div class="row g-3" id="quickLinks">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>

        <!-- Regions List -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Available Regions</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="regionFilter" placeholder="Filter regions by name..." aria-label="Filter regions by name">
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="statusFilter" aria-label="Filter regions by status">
                            <option value="">All Statuses</option>
                            <option value="assigned">Assigned</option>
                            <option value="unassigned">Unassigned</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th id="sortRegionName">Region Name <i class="fas fa-sort"></i></th>
                                <th id="sortCenter">Center Coordinates <i class="fas fa-sort"></i></th>
                                <th id="sortStatus">Status <i class="fas fa-sort"></i></th>
                                <th id="sortSchedule">Schedule <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="regionsList">
                            <!-- Regions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Region Details Modal -->
    <div class="modal fade" id="regionDetailsModal" tabindex="-1" aria-labelledby="regionDetailsTitle">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="regionDetailsTitle">Region Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Region Name:</h6>
                            <p id="detailRegionName"></p>
                            <h6>Center Coordinates:</h6>
                            <p id="detailCenter"></p>
                            <h6>Status:</h6>
                            <p id="detailStatus"></p>
                            <h6>Schedule:</h6>
                            <p id="detailSchedule"></p>
                            <h6>Notes:</h6>
                            <p id="detailNotes"></p>
                        </div>
                        <div class="col-md-6">
                            <div id="detailMap"></div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Coordinates:</h6>
                        <ul id="detailCoordinates" class="list-group">
                            <!-- Coordinates will be populated here -->
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="zoomToRegionBtn" aria-label="Zoom to region on map">Zoom to Region</button>
                    <button type="button" class="btn btn-success" id="startNavigationBtn" aria-label="Start navigation">Start Navigation</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
        <div id="notificationToast" class="toast notification" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Placeholder for footer (loaded from bottomnav.html) -->
    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Include API keys -->
    <script src="/assets/js/apikeys.js"></script>
    <!-- Include Google Maps API -->
    <script>
        // Define initMap globally so Google can access it
        function initMap() {
          const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: -34.397, lng: 150.644 },
            zoom: 8,
          });
        }
      
        // Dynamically create the script tag
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${window.apiKeys.GOOGLE_MAPS_API_KEY}&callback=initMap&libraries=directions`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    </script>
      
    <!-- Include logout handling -->
    <script type="module" src="/assets/js/logout-ui.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        // Load navigation from tranav.html
        async function loadNavigation() {
            try {
                const response = await fetch('/assets/templates/tranav.html');
                if (!response.ok) throw new Error('Failed to load navigation');
                const navHtml = await response.text();
                document.getElementById('nav-placeholder').innerHTML = navHtml;

                // Reinitialize Bootstrap components (e.g., dropdowns) after loading
                const dropdowns = document.querySelectorAll('.dropdown-toggle');
                dropdowns.forEach(dropdown => {
                    new bootstrap.Dropdown(dropdown);
                });
            } catch (error) {
                console.error('Error loading navigation:', error);
                showNotification('Error', 'Failed to load navigation.');
            }
        }

        // Load footer from bottomnav.html
        async function loadFooter() {
            try {
                const response = await fetch('/assets/templates/bottomnav.html');
                if (!response.ok) throw new Error('Failed to load footer');
                const footerHtml = await response.text();
                document.getElementById('footer-placeholder').innerHTML = footerHtml;
            } catch (error) {
                console.error('Error loading footer:', error);
                showNotification('Error', 'Failed to load footer.');
            }
        }

        // Use API keys from apikeys.js
        const firebaseConfig = window.apiKeys.firebase;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        let map;
        let detailMap;
        let currentMapType = 'roadmap';
        let regionPolylines = {};
        let markers = [];
        let assignedRegions = [];
        let filteredRegions = [];
        let sortColumn = 'name';
        let sortDirection = 'asc';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadNavigation(), loadFooter()]); // Load nav and footer
            setupAuthListener();
            setupEventListeners();
            enableTooltips();
        });

        // Authentication state listener
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const transporterId = user.uid;
                    showLoadingSpinner();
                    loadAssignedRegions(transporterId);
                } else {
                    window.location.href = '/login.html';
                }
            });
        }

        // Initialize the Google Map
        window.initMap = function() {
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 13.1005, lng: 77.5890 }, // Default to Yelahanka
                    zoom: 12,
                    mapTypeId: 'roadmap'
                });
                drawRegions();
            } catch (error) {
                console.error('Error initializing map:', error);
                showNotification('Error', 'Failed to initialize map. Please check API key.');
            }
        };

        // Set map type (roadmap or satellite)
        function setMapType(type) {
            if (map) {
                map.setMapTypeId(type);
                currentMapType = type;
                drawRegions();
            }
        }

        // Calculate center of a region
        function calculateCenter(coordinates) {
            if (!Array.isArray(coordinates) || coordinates.length === 0) {
                return { lat: 13.1005, lng: 77.5890 }; // Default to Yelahanka
            }
            const bounds = new google.maps.LatLngBounds();
            let validCoords = 0;
            coordinates.forEach(coord => {
                if (coord && typeof coord.lat === 'number' && typeof coord.lng === 'number') {
                    bounds.extend({ lat: coord.lat, lng: coord.lng });
                    validCoords++;
                }
            });
            if (validCoords === 0) {
                return { lat: 13.1005, lng: 77.5890 }; // Default to Yelahanka
            }
            return bounds.getCenter().toJSON();
        }

        // Format coordinates for display
        function formatCoordinates(coord) {
            if (!coord || typeof coord.lat !== 'number' || typeof coord.lng !== 'number') {
                return '(Invalid)';
            }
            return `(${coord.lat.toFixed(4)}, ${coord.lng.toFixed(4)})`;
        }

        // Load assigned regions from Firebase
        function loadAssignedRegions(transporterId) {
            const regionsRef = ref(database, 'regions');

            onValue(regionsRef, (regionsSnapshot) => {
                try {
                    const allRegions = regionsSnapshot.val() || {};
                    assignedRegions = Object.entries(allRegions)
                        .filter(([regionId, region]) => region.transporterUid === transporterId)
                        .map(([regionId, region]) => {
                            const coordinates = Array.isArray(region.coordinates) ? region.coordinates : [];
                            const center = calculateCenter(coordinates);
                            return {
                                id: regionId,
                                name: region.name || 'Unnamed Region',
                                coordinates,
                                center,
                                status: region.status || 'unassigned',
                                schedule: region.schedule ? `${region.schedule.startTime} - ${region.schedule.endTime} on ${region.schedule.days.join(', ')}` : 'No schedule',
                                notes: region.notes || 'No notes'
                            };
                        });

                    filteredRegions = [...assignedRegions];
                    updateSummaryCards();
                    updateQuickLinks();
                    loadRegions();
                    drawRegions();
                    fitMapToRegions();
                    hideLoadingSpinner();

                    if (assignedRegions.length === 0) {
                        showNotification('Info', 'No assigned regions found.');
                    }
                } catch (error) {
                    console.error('Error processing regions:', error);
                    showNotification('Error', 'Failed to process regions data.');
                    hideLoadingSpinner();
                }
            }, (error) => {
                showNotification('Error', `Failed to load regions: ${error.message}`);
                hideLoadingSpinner();
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            const elements = {
                roadmapLayerBtn: document.getElementById('roadmapLayerBtn'),
                satelliteLayerBtn: document.getElementById('satelliteLayerBtn'),
                regionFilter: document.getElementById('regionFilter'),
                statusFilter: document.getElementById('statusFilter'),
                zoomToRegionBtn: document.getElementById('zoomToRegionBtn'),
                startNavigationBtn: document.getElementById('startNavigationBtn'),
                sortRegionName: document.getElementById('sortRegionName'),
                sortCenter: document.getElementById('sortCenter'),
                sortStatus: document.getElementById('sortStatus'),
                sortSchedule: document.getElementById('sortSchedule')
            };

            if (elements.roadmapLayerBtn) elements.roadmapLayerBtn.addEventListener('click', () => {
                setMapType('roadmap');
                elements.roadmapLayerBtn.classList.add('active');
                elements.satelliteLayerBtn.classList.remove('active');
            });
            if (elements.satelliteLayerBtn) elements.satelliteLayerBtn.addEventListener('click', () => {
                setMapType('satellite');
                elements.satelliteLayerBtn.classList.add('active');
                elements.roadmapLayerBtn.classList.remove('active');
            });
            if (elements.regionFilter) elements.regionFilter.addEventListener('input', debounce(filterRegions, 300));
            if (elements.statusFilter) elements.statusFilter.addEventListener('change', filterRegions);
            if (elements.zoomToRegionBtn) elements.zoomToRegionBtn.addEventListener('click', () => {
                const regionId = document.getElementById('regionDetailsTitle')?.dataset.regionId;
                if (regionId) zoomToRegion(regionId);
            });
            if (elements.startNavigationBtn) elements.startNavigationBtn.addEventListener('click', () => {
                const regionId = document.getElementById('regionDetailsTitle')?.dataset.regionId;
                if (regionId) startNavigation(regionId);
            });
            if (elements.sortRegionName) elements.sortRegionName.addEventListener('click', () => sortRegions('name'));
            if (elements.sortCenter) elements.sortCenter.addEventListener('click', () => sortRegions('center'));
            if (elements.sortStatus) elements.sortStatus.addEventListener('click', () => sortRegions('status'));
            if (elements.sortSchedule) elements.sortSchedule.addEventListener('click', () => sortRegions('schedule'));
        }

        // Enable tooltips
        function enableTooltips() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(element => new bootstrap.Tooltip(element));
        }

        // Show loading spinner
        function showLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'block';
        }

        // Hide loading spinner
        function hideLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';
        }

        // Update summary cards
        function updateSummaryCards() {
            const summaryCards = document.getElementById('regionSummaryCards');
            if (!summaryCards) return;
            summaryCards.innerHTML = `
                <div class="col-md-3">
                    <div class="card bg-success text-white region-card">
                        <div class="card-body">
                            <h5 class="card-title">Center Location</h5>
                            <p class="card-text">Yelahanka, Bangalore</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white region-card">
                        <div class="card-body">
                            <h5 class="card-title">Total Regions</h5>
                            <p class="card-text">${assignedRegions.length} Assigned Regions</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white region-card">
                        <div class="card-body">
                            <h5 class="card-title">Assigned Regions</h5>
                            <p class="card-text">${assignedRegions.filter(r => r.status === 'assigned').length}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update quick links
        function updateQuickLinks() {
            const quickLinks = document.getElementById('quickLinks');
            if (!quickLinks) return;
            quickLinks.innerHTML = '';

            if (filteredRegions.length === 0) {
                quickLinks.innerHTML = '<p>No assigned regions available.</p>';
                return;
            }

            filteredRegions.forEach(region => {
                const div = document.createElement('div');
                div.className = 'col-md-2';
                div.innerHTML = `<button class="btn btn-outline-success w-100 quick-link-btn view-region-btn" data-region-id="${region.id}" aria-label="View region ${region.name}">${region.name}</button>`;
                quickLinks.appendChild(div);
            });

            const viewButtons = quickLinks.querySelectorAll('.view-region-btn');
            viewButtons.forEach(btn => {
                btn.addEventListener('click', () => viewRegion(btn.dataset.regionId));
            });
        }

        // Draw regions on the map
        function drawRegions() {
            // Clear existing polylines and markers
            Object.values(regionPolylines).forEach(polyline => polyline.setMap(null));
            regionPolylines = {};
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            const visibleRegions = filteredRegions.slice(0, 50); // Limit to 50 regions for performance
            visibleRegions.forEach(region => {
                const coordinates = region.coordinates.map(coord => ({
                    lat: coord.lat,
                    lng: coord.lng
                })).filter(coord => typeof coord.lat === 'number' && typeof coord.lng === 'number');
                if (coordinates.length === 0) return;

                const color = getStatusColor(region.status);
                const polyline = new google.maps.Polygon({
                    paths: [...coordinates, coordinates[0]], // Close the polygon
                    strokeColor: color,
                    strokeOpacity: 0.7,
                    strokeWeight: 4,
                    fillColor: color,
                    fillOpacity: 0.2,
                    map: map
                });
                polyline.addListener('click', () => viewRegionDetails(region.id));
                polyline.addListener('mouseover', () => polyline.setOptions({ strokeWeight: 6, strokeOpacity: 1 }));
                polyline.addListener('mouseout', () => polyline.setOptions({ strokeWeight: 4, strokeOpacity: 0.7 }));
                regionPolylines[region.id] = polyline;

                const centerMarker = new google.maps.Marker({
                    position: region.center,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: '#28a745',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                        scale: 6
                    }
                });
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div><h6>${region.name}</h6><p>Center: ${formatCoordinates(region.center)}</p></div>`
                });
                centerMarker.addListener('click', () => infoWindow.open(map, centerMarker));
                markers.push(centerMarker);
            });
        }

        // Fit map to show all regions
        function fitMapToRegions() {
            if (filteredRegions.length === 0 || !map) {
                if (map) map.setCenter({ lat: 13.1005, lng: 77.5890 });
                if (map) map.setZoom(12);
                return;
            }

            const bounds = new google.maps.LatLngBounds();
            let hasValidCoords = false;
            filteredRegions.forEach(region => {
                region.coordinates.forEach(coord => {
                    if (typeof coord.lat === 'number' && typeof coord.lng === 'number') {
                        bounds.extend({ lat: coord.lat, lng: coord.lng });
                        hasValidCoords = true;
                    }
                });
            });
            if (hasValidCoords) {
                map.fitBounds(bounds);
            } else {
                map.setCenter({ lat: 13.1005, lng: 77.5890 });
                map.setZoom(12);
            }
        }

        // View specific region
        function viewRegion(regionId) {
            const region = assignedRegions.find(r => r.id === regionId);
            if (!region) {
                showNotification('Error', 'Region not found.');
                return;
            }

            const bounds = new google.maps.LatLngBounds();
            let hasValidCoords = false;
            region.coordinates.forEach(coord => {
                if (typeof coord.lat === 'number' && typeof coord.lng === 'number') {
                    bounds.extend({ lat: coord.lat, lng: coord.lng });
                    hasValidCoords = true;
                }
            });
            if (hasValidCoords) {
                map.fitBounds(bounds);
            }

            Object.values(regionPolylines).forEach(polyline => polyline.setOptions({ strokeOpacity: 0.3, fillOpacity: 0.1 }));
            if (regionPolylines[regionId]) {
                regionPolylines[regionId].setOptions({ strokeOpacity: 1, fillOpacity: 0.2 });
            }

            viewRegionDetails(regionId);
        }

        // Zoom to region on main map
        function zoomToRegion(regionId) {
            const region = assignedRegions.find(r => r.id === regionId);
            if (!region) return;

            const bounds = new google.maps.LatLngBounds();
            let hasValidCoords = false;
            region.coordinates.forEach(coord => {
                if (typeof coord.lat === 'number' && typeof coord.lng === 'number') {
                    bounds.extend({ lat: coord.lat, lng: coord.lng });
                    hasValidCoords = true;
                }
            });
            if (hasValidCoords) {
                map.fitBounds(bounds);
            }
            hideModal('regionDetailsModal');
        }

        // Generate waypoints for navigation within the region
        function generateWaypoints(coordinates) {
            if (!Array.isArray(coordinates) || coordinates.length === 0) {
                return [];
            }

            // Filter valid coordinates
            const validCoords = coordinates.filter(coord => 
                typeof coord.lat === 'number' && typeof coord.lng === 'number'
            );

            if (validCoords.length === 0) {
                return [];
            }

            // Use polygon vertices as waypoints, limit to 23 to stay within Directions API limit (25 total, including origin and destination)
            let waypoints = validCoords.slice(0, 23);

            // If fewer than 5 waypoints, add intermediate points to ensure coverage
            if (waypoints.length < 5 && validCoords.length > 1) {
                const bounds = new google.maps.LatLngBounds();
                validCoords.forEach(coord => bounds.extend({ lat: coord.lat, lng: coord.lng }));
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();

                // Add points within the bounds (simple grid approach)
                const extraPoints = [];
                const latStep = (ne.lat() - sw.lat()) / 3;
                const lngStep = (ne.lng() - sw.lng()) / 3;

                for (let i = 1; i <= 2; i++) {
                    for (let j = 1; j <= 2; j++) {
                        const lat = sw.lat() + i * latStep;
                        const lng = sw.lng() + j * lngStep;
                        // Check if point is inside the polygon
                        const point = { lat, lng };
                        if (isPointInPolygon(point, validCoords)) {
                            extraPoints.push(point);
                        }
                    }
                }

                waypoints = [...waypoints, ...extraPoints].slice(0, 23);
            }

            return waypoints;
        }

        // Check if a point is inside a polygon
        function isPointInPolygon(point, polygon) {
            let x = point.lat, y = point.lng;
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                let xi = polygon[i].lat, yi = polygon[i].lng;
                let xj = polygon[j].lat, yj = polygon[j].lng;
                let intersect = ((yi > y) !== (yj > y)) && 
                    (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        // Start navigation (open Google Maps with route through region)
        function startNavigation(regionId) {
            const region = assignedRegions.find(r => r.id === regionId);
            if (!region) {
                showNotification('Error', 'Region not found.');
                return;
            }

            const waypoints = generateWaypoints(region.coordinates);
            if (waypoints.length === 0) {
                showNotification('Error', 'No valid coordinates to generate a route.');
                return;
            }

            // Use the first coordinate as the origin and the last as the destination
            const origin = waypoints[0];
            const destination = waypoints[waypoints.length - 1];
            const waypointParams = waypoints
                .slice(1, -1) // Exclude origin and destination
                .map(coord => `${coord.lat},${coord.lng}`)
                .join('|');

            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1` +
                `&origin=${origin.lat},${origin.lng}` +
                `&destination=${destination.lat},${destination.lng}` +
                (waypointParams ? `&waypoints=${waypointParams}` : '') +
                `&travelmode=driving`;

            window.open(googleMapsUrl, '_blank');
        }

        // Show region details modal
        function viewRegionDetails(regionId) {
            const region = assignedRegions.find(r => r.id === regionId);
            if (!region) {
                showNotification('Error', 'Region not found.');
                return;
            }

            document.getElementById('regionDetailsTitle').textContent = region.name;
            document.getElementById('regionDetailsTitle').dataset.regionId = regionId;
            document.getElementById('detailRegionName').textContent = region.name;
            document.getElementById('detailCenter').textContent = formatCoordinates(region.center);
            const statusText = region.status.charAt(0).toUpperCase() + region.status.slice(1);
            const statusClass = getStatusClass(region.status);
            document.getElementById('detailStatus').innerHTML = `<span class="badge ${statusClass}">${statusText}</span>`;
            document.getElementById('detailSchedule').textContent = region.schedule;
            document.getElementById('detailNotes').textContent = region.notes || 'No notes available';

            const coordinatesList = document.getElementById('detailCoordinates');
            coordinatesList.innerHTML = '';
            if (region.coordinates.length === 0) {
                coordinatesList.innerHTML = '<li class="list-group-item">No coordinates defined</li>';
            } else {
                region.coordinates.forEach((coord, index) => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item';
                    item.textContent = `${index + 1}. ${formatCoordinates(coord)}`;
                    coordinatesList.appendChild(item);
                });
            }

            if (detailMap) detailMap = null;
            setTimeout(() => {
                try {
                    detailMap = new google.maps.Map(document.getElementById('detailMap'), {
                        center: region.center,
                        zoom: 11,
                        mapTypeId: 'roadmap'
                    });
                    const validCoordinates = region.coordinates.filter(coord => 
                        typeof coord.lat === 'number' && typeof coord.lng === 'number'
                    );
                    if (validCoordinates.length > 0) {
                        const polyline = new google.maps.Polygon({
                            paths: [...validCoordinates, validCoordinates[0]],
                            strokeColor: getStatusColor(region.status),
                            strokeOpacity: 0.7,
                            strokeWeight: 4,
                            fillColor: getStatusColor(region.status),
                            fillOpacity: 0.2,
                            map: detailMap
                        });
                        const centerMarker = new google.maps.Marker({
                            position: region.center,
                            map: detailMap,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: '#28a745',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2,
                                scale: 6
                            }
                        });
                        const bounds = new google.maps.LatLngBounds();
                        validCoordinates.forEach(coord => bounds.extend({ lat: coord.lat, lng: coord.lng }));
                        detailMap.fitBounds(bounds);
                    } else {
                        showNotification('Warning', 'No valid coordinates for region map.');
                    }
                } catch (error) {
                    console.error("Error initializing detail map:", error);
                    showNotification('Error', 'Failed to load region details map.');
                }
            }, 100);

            showModal('regionDetailsModal');
        }

        // Filter regions
        function filterRegions() {
            const searchTerm = document.getElementById('regionFilter')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';

            filteredRegions = assignedRegions.filter(region => {
                const matchesName = region.name.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || region.status === statusFilter;
                return matchesName && matchesStatus;
            });

            updateQuickLinks();
            loadRegions();
            drawRegions();
            fitMapToRegions();
        }

        // Sort regions
        function sortRegions(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredRegions.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (column === 'center') {
                    valA = `${a.center.lat},${a.center.lng}`;
                    valB = `${b.center.lat},${b.center.lng}`;
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            const headers = document.querySelectorAll('th');
            headers.forEach(header => {
                header.classList.remove('active');
                const icon = header.querySelector('i');
                if (icon) icon.className = 'fas fa-sort';
            });

            const activeHeader = document.getElementById(`sort${column.charAt(0).toUpperCase() + column.slice(1)}`);
            if (activeHeader) {
                activeHeader.classList.add('active');
                const icon = activeHeader.querySelector('i');
                if (icon) icon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}`;
            }

            loadRegions();
        }

        // Load regions into table
        function loadRegions() {
            const regionsList = document.getElementById('regionsList');
            if (!regionsList) return;
            regionsList.innerHTML = filteredRegions.length === 0 ? '<tr><td colspan="5" class="text-center">No regions available.</td></tr>' : '';
            filteredRegions.forEach(region => {
                const statusClass = getStatusClass(region.status);
                const statusText = region.status.charAt(0).toUpperCase() + region.status.slice(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${region.name}</td>
                    <td>${formatCoordinates(region.center)}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${region.schedule}</td>
                    <td class="region-actions">
                        <button class="btn btn-sm btn-outline-primary view-details-btn" data-region-id="${region.id}" aria-label="View details of region ${region.name}"><i class="fas fa-eye"></i></button>
                    </td>`;
                regionsList.appendChild(row);
            });

            const viewButtons = regionsList.querySelectorAll('.view-details-btn');
            viewButtons.forEach(btn => {
                btn.addEventListener('click', () => viewRegionDetails(btn.dataset.regionId));
            });
        }

        // Get status class for badge
        function getStatusClass(status) {
            switch (status) {
                case 'assigned': return 'bg-success';
                case 'unassigned': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Get status color for polyline
        function getStatusColor(status) {
            switch (status) {
                case 'assigned': return '#28a745';
                case 'unassigned': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // Show notification
        function showNotification(title, message) {
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            if (toastTitle && toastMessage) {
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
                toast.show();
            }
        }

        // Show modal
        function showModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        // Hide modal
        function hideModal(modalId) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (modal) modal.hide();
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>