<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Region Management - BinXZer0</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        #map { height: 500px; width: 100%; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); z-index: 1; }
        #regionPreviewMap { height: 200px; border-radius: 8px; }
        .region-actions { display: flex; gap: 10px; }
        .info-window { padding: 5px; }
        .info-window h6 { margin: 0 0 5px; color: #28a745; }
        .info-window p { margin: 0; font-size: 0.9em; }
        .map-controls { position: absolute; top: 10px; left: 10px; z-index: 2; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .map-controls .btn.active { background-color: #28a745; color: white; }
        .region-card { transition: transform 0.2s ease; }
        .region-card:hover { transform: translateY(-2px); }
        .notification { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .transporter-select { max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; }
        .modal-content { border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .modal-header { border-bottom: 1px solid #dee2e6; }
        .modal-footer { border-top: 1px solid #dee2e6; }
        .btn-success { background-color: #28a745; border-color: #28a745; }
        .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        .list-group-item-action:hover { background-color: #e9ecef; }
        .invalid-field { border-color: #dc3545 !important; }
        .loading-spinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050; }
        .table th { cursor: pointer; }
        .table th:hover { background-color: #e9ecef; }
        .table th.active { background-color: #d4edda; }
        .status-assigned { color: #28a745; }
        .status-unassigned { color: #dc3545; }
        .status-in_progress { color: #ffc107; }
        .status-completed { color: #007bff; }
        .days-of-week { display: flex; gap: 5px; flex-wrap: wrap; }
        .day-checkbox { display: none; }
        .day-label { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: 50%; background-color: #f5f5f5; color: #1a1a1a; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .day-checkbox:checked + .day-label { background-color: #28a745; color: white; }
        #bottom-nav {
            display: block !important;
            width: 100%;
            background-color: #343a40;
            color: white;
        }
    </style>
</head>
<body>
    <div id="admin-nav-container"></div>

    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Region Management</h1>
            <button class="btn btn-success" id="addRegionBtn" aria-label="Add a new region"><i class="fas fa-plus me-2"></i>Add New Region</button>
        </div>

        <div class="position-relative mb-4">
            <div id="map"></div>
            <div class="map-controls">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-success active" id="streetLayerBtn" data-bs-toggle="tooltip" title="Switch to street view" role="button" aria-pressed="true"><i class="fas fa-road"></i> Street</button>
                    <button class="btn btn-sm btn-outline-success" id="satelliteLayerBtn" data-bs-toggle="tooltip" title="Switch to satellite view" role="button" aria-pressed="false"><i class="fas fa-satellite"></i> Satellite</button>
                </div>
                <div class="btn-group mt-2">
                    <button class="btn btn-sm btn-outline-primary" id="drawRegionBtn" aria-label="Draw a new region"><i class="fas fa-draw-polygon"></i> Draw</button>
                    <button class="btn btn-sm btn-outline-secondary" id="editRegionBtn" aria-label="Edit an existing region" disabled><i class="fas fa-edit"></i> Edit</button>
                </div>
                <div class="btn-group mt-2">
                    <button class="btn btn-sm btn-outline-primary" id="clearDrawingBtn" aria-label="Clear drawing"><i class="fas fa-trash-alt"></i> Clear</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Available Regions</h5>
                <div class="mb-3">
                    <input type="text" class="form-control" id="regionFilter" placeholder="Filter regions by name..." aria-label="Filter regions by name">
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th id="sortRegionName" role="button" aria-sort="none">Region Name <i class="fas fa-sort"></i></th>
                                <th id="sortAssignedTo" role="button" aria-sort="none">Assigned To <i class="fas fa-sort"></i></th>
                                <th id="sortSchedule" role="button" aria-sort="none">Schedule <i class="fas fa-sort"></i></th>
                                <th id="sortStatus" role="button" aria-sort="none">Status <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="regionsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="regionModal" tabindex="-1" aria-labelledby="regionModalTitle">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="regionModalTitle">Add New Region</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Fill in the region details. Click save when you're done.</p>
                    <form id="regionForm">
                        <input type="hidden" id="regionId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="regionName" class="form-label">Region Name</label>
                                    <input type="text" class="form-control" id="regionName" placeholder="Enter region name" required aria-required="true">
                                    <div class="invalid-feedback">Region name is required</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="regionStatus" class="form-label">Status</label>
                                    <select class="form-select" id="regionStatus" required aria-required="true">
                                        <option value="unassigned">Unassigned</option>
                                        <option value="assigned">Assigned</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startTime" class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="startTime" aria-label="Start time">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endTime" class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="endTime" aria-label="End time">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Recurring Days</label>
                            <div class="days-of-week">
                                <input type="checkbox" id="day-sun" class="day-checkbox" value="0"><label for="day-sun" class="day-label">S</label>
                                <input type="checkbox" id="day-mon" class="day-checkbox" value="1"><label for="day-mon" class="day-label">M</label>
                                <input type="checkbox" id="day-tue" class="day-checkbox" value="2"><label for="day-tue" class="day-label">T</label>
                                <input type="checkbox" id="day-wed" class="day-checkbox" value="3"><label for="day-wed" class="day-label">W</label>
                                <input type="checkbox" id="day-thu" class="day-checkbox" value="4"><label for="day-thu" class="day-label">T</label>
                                <input type="checkbox" id="day-fri" class="day-checkbox" value="5"><label for="day-fri" class="day-label">F</label>
                                <input type="checkbox" id="day-sat" class="day-checkbox" value="6"><label for="day-sat" class="day-label">S</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="regionNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="regionNotes" rows="3" placeholder="Enter region notes" aria-label="Region notes"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Assign to Transporter</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="transporterSearchModal" placeholder="Search transporters..." aria-label="Search transporters">
                            </div>
                            <div class="transporter-select list-group" id="transporterListModal"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Region Preview</label>
                            <div id="regionPreviewMap"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="clearRegionFormBtn" aria-label="Clear form">Clear</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveRegionBtn" aria-label="Save region">Save Region</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalTitle">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignModalTitle">Assign Region</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Assign <strong id="assignRegionName"></strong> to:</p>
                    <input type="hidden" id="assignRegionId">
                    <div class="mb-3">
                        <label for="transporterSearch" class="form-label">Search Transporters</label>
                        <input type="text" class="form-control" id="transporterSearch" placeholder="Type to search..." aria-label="Search transporters">
                    </div>
                    <div class="transporter-select list-group" id="transporterList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAssignBtn" aria-label="Assign region">Assign</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="regionDetailsModal" tabindex="-1" aria-labelledby="regionDetailsTitle">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="regionDetailsTitle">Region Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Region Name:</h6><p id="detailRegionName"></p>
                            <h6>Assigned To:</h6><p id="detailAssigned"></p>
                            <h6>Status:</h6><p id="detailStatus"></p>
                            <h6>Schedule:</h6><p id="detailSchedule"></p>
                            <h6>Notes:</h6><p id="detailNotes"></p>
                        </div>
                        <div class="col-md-6">
                            <div id="detailMap" style="height: 250px; border-radius: 8px;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="zoomToRegionBtn" aria-label="Zoom to region on map">Zoom to Region</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Close</button>
                    <button type="button" class="btn btn-primary" id="editRegionBtnModal" aria-label="Edit region">Edit Region</button>
                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
        <div id="notificationToast" class="toast notification" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div id="bottom-nav"></div>

    <script src="/assets/js/apikeys.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, update, remove, get } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        const app = initializeApp(window.apiKeys.firebase);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const RegionManagement = (() => {
            let map, regionPreviewMap, detailMap;
            let drawnRegions = [];
            let selectedPolygon = null;
            let regions = [];
            let transporters = [];
            let currentRegionId = null;
            let selectedTransporter = { email: null, uid: null };
            let sortColumn = 'regionName';
            let sortDirection = 'asc';
            let currentMapLayer = 'roadmap';
            let drawingManager = null;
            let isGoogleMapsLoaded = false;

            const elements = {
                addRegionBtn: document.getElementById('addRegionBtn'),
                saveRegionBtn: document.getElementById('saveRegionBtn'),
                clearRegionFormBtn: document.getElementById('clearRegionFormBtn'),
                drawRegionBtn: document.getElementById('drawRegionBtn'),
                clearDrawingBtn: document.getElementById('clearDrawingBtn'),
                editRegionBtn: document.getElementById('editRegionBtn'),
                editRegionBtnModal: document.getElementById('editRegionBtnModal'),
                regionFilter: document.getElementById('regionFilter'),
                regionNameInput: document.getElementById('regionName'),
                regionStatusSelect: document.getElementById('regionStatus'),
                startTimeInput: document.getElementById('startTime'),
                endTimeInput: document.getElementById('endTime'),
                regionNotesInput: document.getElementById('regionNotes'),
                transporterSearchModal: document.getElementById('transporterSearchModal'),
                transporterListModal: document.getElementById('transporterListModal'),
                transporterSearch: document.getElementById('transporterSearch'),
                transporterList: document.getElementById('transporterList'),
                confirmAssignBtn: document.getElementById('confirmAssignBtn'),
                zoomToRegionBtn: document.getElementById('zoomToRegionBtn'),
                streetLayerBtn: document.getElementById('streetLayerBtn'),
                satelliteLayerBtn: document.getElementById('satelliteLayerBtn'),
                sortRegionName: document.getElementById('sortRegionName'),
                sortAssignedTo: document.getElementById('sortAssignedTo'),
                sortSchedule: document.getElementById('sortSchedule'),
                sortStatus: document.getElementById('sortStatus'),
                dayCheckboxes: document.querySelectorAll('.day-checkbox')
            };

            const sanitizeInput = (input) => DOMPurify.sanitize(input);

            function initMap() {
                if (!window.google || !window.google.maps) {
                    console.warn('Google Maps API not fully loaded');
                    setTimeout(initMap, 500);
                    return;
                }
                try {
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: { lat: 13.1005, lng: 77.5890 },
                        zoom: 12,
                        mapTypeId: 'roadmap'
                    });

                    drawingManager = new google.maps.drawing.DrawingManager({
                        drawingMode: null,
                        drawingControl: false,
                        drawingControlOptions: {
                            position: google.maps.ControlPosition.TOP_CENTER,
                            drawingModes: [google.maps.drawing.OverlayType.POLYGON]
                        },
                        polygonOptions: {
                            strokeColor: '#FF0000',
                            fillColor: '#FF0000',
                            fillOpacity: 0.3,
                            strokeWeight: 2,
                            editable: false,
                            clickable: true
                        }
                    });
                    drawingManager.setMap(map);

                    google.maps.event.addListener(drawingManager, 'polygoncomplete', (polygon) => {
                        if (selectedPolygon && !selectedPolygon.regionId) {
                            selectedPolygon.setMap(null);
                        }
                        selectedPolygon = polygon;
                        if (selectedPolygon && selectedPolygon.getPath().getLength() > 2) {
                            elements.saveRegionBtn.disabled = false;
                            showNotification('Success', 'Region drawn. Please fill in details.');
                            openRegionModal();
                            drawingManager.setDrawingMode(null);
                        } else {
                            showNotification('Error', 'Invalid region drawn. Please try again.');
                            selectedPolygon.setMap(null);
                            selectedPolygon = null;
                        }
                    });

                    google.maps.event.addListener(drawingManager, 'overlaycomplete', () => {
                        updateRegionPreviewMap();
                    });

                    loadRegions();
                    loadTransporters();
                    isGoogleMapsLoaded = true;
                    hideLoadingSpinner();
                } catch (error) {
                    console.error('Map initialization error:', error);
                    showNotification('Error', 'Failed to initialize map. Please refresh.');
                    hideLoadingSpinner();
                }
            }

            function loadGoogleMapsAPI() {
                if (!window.apiKeys || !window.apiKeys.GOOGLE_MAPS_API_KEY) {
                    showNotification('Error', 'Google Maps API key missing in apikeys.js');
                    hideLoadingSpinner();
                    return;
                }
                window.initMap = initMap;
                const script = document.createElement('script');
                const apiKey = window.apiKeys.GOOGLE_MAPS_API_KEY;
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=drawing&callback=initMap&loading=async`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);

                script.onload = () => {
                    isGoogleMapsLoaded = true;
                    console.log('Google Maps API loaded successfully');
                };
                script.onerror = () => {
                    showNotification('Error', 'Failed to load Google Maps API. Check API key or network.');
                    hideLoadingSpinner();
                };
            }

            function initRegionPreviewMap() {
                try {
                    regionPreviewMap = new google.maps.Map(document.getElementById('regionPreviewMap'), {
                        center: { lat: 13.1005, lng: 77.5890 },
                        zoom: 12,
                        mapTypeId: 'roadmap'
                    });
                    updateRegionPreviewMap();
                } catch (error) {
                    console.error('Region preview map error:', error);
                    showNotification('Error', 'Failed to initialize region preview map.');
                }
            }

            function setMapLayer(type) {
                if (map) {
                    map.setMapTypeId(type);
                    currentMapLayer = type;
                    drawRegions();
                }
            }

            async function loadTransporters() {
                try {
                    showLoadingSpinner();
                    let attempts = 0;
                    while (attempts < 3) {
                        try {
                            const snapshot = await get(ref(db, 'transporters'));
                            transporters = [];
                            const data = snapshot.val() || {};
                            if (Object.keys(data).length === 0) {
                                showNotification('Warning', 'No transporters found.');
                            } else {
                                Object.entries(data).forEach(([id, value]) => {
                                    const transporterName = value.fullName && value.fullName !== 'undefined' ? value.fullName : 'Unnamed Transporter';
                                    transporters.push({
                                        id,
                                        name: sanitizeInput(transporterName),
                                        email: value.email || 'No email'
                                    });
                                });
                                showNotification('Success', `Loaded ${transporters.length} transporters.`);
                            }
                            populateTransportersInModal();
                            populateTransportersInAssignModal();
                            break;
                        } catch (error) {
                            attempts++;
                            if (attempts === 3) throw error;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                } catch (error) {
                    console.error('Transporter load error:', error);
                    let message = 'Failed to load transporters.';
                    if (error.code === 'PERMISSION_DENIED') {
                        message = 'Permission denied. Please sign in or check Firebase rules.';
                    } else if (error.code === 'NETWORK_ERROR') {
                        message = 'Network error. Please check your connection.';
                    }
                    showNotification('Error', message);
                } finally {
                    hideLoadingSpinner();
                }
            }

            function populateTransportersInModal() {
                elements.transporterListModal.innerHTML = '';
                if (transporters.length === 0) {
                    elements.transporterListModal.innerHTML = '<div class="list-group-item text-center">No transporters available.</div>';
                    return;
                }
                transporters.forEach(t => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <span>${t.name} (${t.email})</span>
                        <span class="badge bg-success rounded-pill">Active</span>
                    `;
                    item.addEventListener('click', () => {
                        selectedTransporter = { email: t.email, uid: t.id };
                        elements.transporterSearchModal.value = t.email;
                        elements.transporterListModal.innerHTML = '';
                        showNotification('Info', `Selected transporter: ${t.name}`);
                    });
                    elements.transporterListModal.appendChild(item);
                });
            }

            function populateTransportersInAssignModal() {
                elements.transporterList.innerHTML = '';
                if (transporters.length === 0) {
                    elements.transporterList.innerHTML = '<div class="list-group-item text-center">No transporters available.</div>';
                    return;
                }
                transporters.forEach(t => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <span>${t.name} (${t.email})</span>
                        <span class="badge bg-success rounded-pill">Active</span>
                    `;
                    item.addEventListener('click', () => {
                        selectedTransporter = { email: t.email, uid: t.id };
                        elements.transporterSearch.value = t.email;
                        elements.transporterList.innerHTML = '';
                        showNotification('Info', `Selected transporter: ${t.name}`);
                    });
                    elements.transporterList.appendChild(item);
                });
            }

            const debounceSearchModal = debounce(() => {
                const searchTerm = elements.transporterSearchModal.value.toLowerCase();
                elements.transporterListModal.innerHTML = '';
                const filteredTransporters = transporters.filter(t =>
                    t.name.toLowerCase().includes(searchTerm) || t.email.toLowerCase().includes(searchTerm)
                );
                if (filteredTransporters.length === 0) {
                    elements.transporterListModal.innerHTML = '<div class="list-group-item text-center">No matching transporters found.</div>';
                    return;
                }
                filteredTransporters.forEach(t => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <span>${t.name} (${t.email})</span>
                        <span class="badge bg-success rounded-pill">Active</span>
                    `;
                    item.addEventListener('click', () => {
                        selectedTransporter = { email: t.email, uid: t.id };
                        elements.transporterSearchModal.value = t.email;
                        elements.transporterListModal.innerHTML = '';
                        showNotification('Info', `Selected transporter: ${t.name}`);
                    });
                    elements.transporterListModal.appendChild(item);
                });
            }, 300);

            const debounceSearchAssign = debounce(() => {
                const searchTerm = elements.transporterSearch.value.toLowerCase();
                elements.transporterList.innerHTML = '';
                const filteredTransporters = transporters.filter(t =>
                    t.name.toLowerCase().includes(searchTerm) || t.email.toLowerCase().includes(searchTerm)
                );
                if (filteredTransporters.length === 0) {
                    elements.transporterList.innerHTML = '<div class="list-group-item text-center">No matching transporters found.</div>';
                    return;
                }
                filteredTransporters.forEach(t => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <span>${t.name} (${t.email})</span>
                        <span class="badge bg-success rounded-pill">Active</span>
                    `;
                    item.addEventListener('click', () => {
                        selectedTransporter = { email: t.email, uid: t.id };
                        elements.transporterSearch.value = t.email;
                        elements.transporterList.innerHTML = '';
                        showNotification('Info', `Selected transporter: ${t.name}`);
                    });
                    elements.transporterList.appendChild(item);
                });
            }, 300);

            async function loadRegions() {
                try {
                    const regionsRef = ref(db, 'regions');
                    onValue(regionsRef, (snapshot) => {
                        regions = [];
                        drawnRegions.forEach(polygon => polygon.setMap(null));
                        drawnRegions = [];
                        const regionsData = snapshot.val() || {};
                        Object.entries(regionsData).forEach(([id, data]) => {
                            regions.push({
                                id,
                                regionName: sanitizeInput(data.name || 'Unnamed Region'),
                                coordinates: data.coordinates || [],
                                transporterEmail: data.transporterEmail || null,
                                transporterUid: data.transporterUid || null,
                                status: data.status || 'unassigned',
                                schedule: data.schedule || {},
                                notes: sanitizeInput(data.notes || ''),
                                createdAt: data.createdAt || null,
                                updatedAt: data.updatedAt || null
                            });
                        });
                        sortRegions(sortColumn);
                        updateRegionsList();
                        drawRegions();
                        if (regions.length > 0) {
                            const bounds = new google.maps.LatLngBounds();
                            regions.forEach(region => {
                                if (region.coordinates.length > 0) {
                                    region.coordinates.forEach(coord => bounds.extend({ lat: coord.lat, lng: coord.lng }));
                                }
                            });
                            if (!bounds.isEmpty()) map.fitBounds(bounds);
                        }
                        hideLoadingSpinner();
                    }, (error) => {
                        console.error('Regions load error:', error);
                        showNotification('Error', `Failed to load regions: ${error.message}`);
                        hideLoadingSpinner();
                    });
                } catch (error) {
                    console.error('Regions load error:', error);
                    showNotification('Error', `Failed to load regions: ${error.message}`);
                    hideLoadingSpinner();
                }
            }

            function drawRegions() {
                drawnRegions.forEach(polygon => polygon.setMap(null));
                drawnRegions = [];
                const statusColors = {
                    'unassigned': '#FF0000',
                    'assigned': '#28a745',
                    'in_progress': '#FFC107',
                    'completed': '#007bff'
                };

                regions.forEach(region => {
                    if (region.coordinates.length > 0) {
                        const coords = region.coordinates.map(c => ({ lat: c.lat, lng: c.lng }));
                        const color = statusColors[region.status] || '#FF0000';
                        const polygon = new google.maps.Polygon({
                            paths: coords,
                            strokeColor: color,
                            fillColor: color,
                            fillOpacity: 0.3,
                            strokeWeight: 2,
                            editable: false,
                            clickable: true,
                            regionId: region.id
                        });
                        polygon.setMap(map);
                        drawnRegions.push(polygon);

                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div class="info-window">
                                    <h6>${region.regionName}</h6>
                                    <p>Status: ${region.status.replace('_', ' ')}</p>
                                    ${region.transporterEmail ? `<p>Assigned to: ${region.transporterEmail}</p>` : ''}
                                    ${region.schedule && region.schedule.days ? `<p>Schedule: ${formatSchedule(region.schedule)}</p>` : ''}
                                </div>
                            `
                        });

                        google.maps.event.addListener(polygon, 'click', () => {
                            selectPolygon(polygon);
                            viewRegionDetails(region.id);
                        });

                        google.maps.event.addListener(polygon, 'mouseover', () => infoWindow.open(map, polygon));
                        google.maps.event.addListener(polygon, 'mouseout', () => infoWindow.close());
                    }
                });
            }

            function selectPolygon(polygon) {
                drawnRegions.forEach(p => {
                    const color = p === polygon ? '#FF6F00' : (p.strokeColor || '#FF0000');
                    p.setOptions({ strokeColor: color, fillColor: color, editable: false });
                });

                selectedPolygon = polygon;
                elements.editRegionBtn.disabled = !polygon || !polygon.regionId;
                elements.editRegionBtnModal.disabled = !polygon || !polygon.regionId;
                if (polygon && polygon.regionId) {
                    const region = regions.find(r => r.id === polygon.regionId);
                    if (region) {
                        const bounds = new google.maps.LatLngBounds();
                        region.coordinates.forEach(coord => bounds.extend({ lat: coord.lat, lng: coord.lng }));
                        map.fitBounds(bounds);
                    }
                }
            }

            function updateRegionsList(filteredRegions = regions) {
                const regionsList = document.getElementById('regionsList');
                regionsList.innerHTML = filteredRegions.length === 0 ? '<tr><td colspan="5" class="text-center">No regions available.</td></tr>' : '';
                filteredRegions.forEach(region => {
                    const scheduleText = region.schedule && region.schedule.days ? formatSchedule(region.schedule) : 'Not set';
                    const transporterName = region.transporterEmail || 'Unassigned';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${region.regionName}</td>
                        <td>${transporterName}</td>
                        <td>${scheduleText}</td>
                        <td><span class="status-${region.status}">${region.status.replace('_', ' ')}</span></td>
                        <td>
                            <button class="btn btn-info btn-sm view-region-btn" data-region-id="${region.id}" aria-label="View region details">View</button>
                            <button class="btn btn-primary btn-sm edit-region-btn" data-region-id="${region.id}" aria-label="Edit region">Edit</button>
                            <button class="btn btn-warning btn-sm assign-region-btn" data-region-id="${region.id}" data-region-name="${region.regionName}" aria-label="Assign region to transporter">Assign</button>
                            <button class="btn btn-danger btn-sm delete-region-btn" data-region-id="${region.id}" aria-label="Delete region">Delete</button>
                        </td>
                    `;
                    regionsList.appendChild(row);
                });

                document.querySelectorAll('.view-region-btn').forEach(btn => btn.addEventListener('click', () => {
                    const polygon = drawnRegions.find(p => p.regionId === btn.dataset.regionId);
                    if (polygon) selectPolygon(polygon);
                    viewRegionDetails(btn.dataset.regionId);
                }));
                document.querySelectorAll('.edit-region-btn').forEach(btn => btn.addEventListener('click', () => {
                    const polygon = drawnRegions.find(p => p.regionId === btn.dataset.regionId);
                    if (polygon) selectPolygon(polygon);
                    editRegion(btn.dataset.regionId);
                }));
                document.querySelectorAll('.assign-region-btn').forEach(btn => btn.addEventListener('click', () => showAssignModal(btn.dataset.regionId, btn.dataset.regionName)));
                document.querySelectorAll('.delete-region-btn').forEach(btn => btn.addEventListener('click', () => deleteRegion(btn.dataset.regionId)));
            }

            function filterRegions() {
                const searchTerm = elements.regionFilter.value.toLowerCase();
                const filteredRegions = regions.filter(region => region.regionName.toLowerCase().includes(searchTerm));
                updateRegionsList(filteredRegions);
                drawRegions();
            }

            function sortRegions(column) {
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }

                regions.sort((a, b) => {
                    let valA = a[column];
                    let valB = b[column];

                    if (column === 'assignedTo') {
                        valA = a.transporterEmail || 'Unassigned';
                        valB = b.transporterEmail || 'Unassigned';
                    } else if (column === 'schedule') {
                        valA = a.schedule && a.schedule.days ? formatSchedule(a.schedule) : '';
                        valB = b.schedule && b.schedule.days ? formatSchedule(b.schedule) : '';
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

                const headers = document.querySelectorAll('th');
                headers.forEach(header => {
                    header.classList.remove('active');
                    const icon = header.querySelector('i');
                    if (icon) icon.className = 'fas fa-sort';
                    header.setAttribute('aria-sort', 'none');
                });

                const activeHeader = document.getElementById(`sort${column.charAt(0).toUpperCase() + column.slice(1)}`);
                if (activeHeader) {
                    activeHeader.classList.add('active');
                    const icon = activeHeader.querySelector('i');
                    if (icon) icon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}`;
                    activeHeader.setAttribute('aria-sort', sortDirection);
                }

                updateRegionsList();
            }

            function openRegionModal() {
                if (!selectedPolygon || !selectedPolygon.getPath || selectedPolygon.getPath().getLength() < 3) {
                    showNotification('Warning', 'Please draw a valid region on the map first.');
                    return;
                }
                document.getElementById('regionModalTitle').textContent = currentRegionId ? 'Edit Region' : 'Add New Region';
                populateTransportersInModal();
                initRegionPreviewMap();
                updateRegionPreviewMap();
                showModal('regionModal');
                elements.saveRegionBtn.disabled = false;
            }

            function resetRegionForm() {
                currentRegionId = null;
                selectedTransporter = { email: null, uid: null };
                if (selectedPolygon && !selectedPolygon.regionId) {
                    selectedPolygon.setMap(null);
                    selectedPolygon = null;
                }
                elements.regionNameInput.value = '';
                elements.regionStatusSelect.value = 'unassigned';
                elements.startTimeInput.value = '';
                elements.endTimeInput.value = '';
                elements.regionNotesInput.value = '';
                elements.transporterSearchModal.value = '';
                elements.dayCheckboxes.forEach(checkbox => checkbox.checked = false);
                document.getElementById('regionId').value = '';
                updateRegionPreviewMap();
                elements.saveRegionBtn.disabled = true;
                elements.editRegionBtn.disabled = true;
                elements.editRegionBtnModal.disabled = true;
            }

            function updateRegionPreviewMap() {
                if (!regionPreviewMap) return;
                regionPreviewMap.data.forEach(feature => regionPreviewMap.data.remove(feature));
                if (selectedPolygon && selectedPolygon.getPath) {
                    const coords = selectedPolygon.getPath().getArray().map(latLng => ({
                        lat: latLng.lat(),
                        lng: latLng.lng()
                    }));
                    const status = elements.regionStatusSelect.value;
                    const color = {
                        'unassigned': '#FF0000',
                        'assigned': '#28a745',
                        'in_progress': '#FFC107',
                        'completed': '#007bff'
                    }[status] || '#FF0000';
                    const previewPolygon = new google.maps.Polygon({
                        paths: coords,
                        strokeColor: color,
                        fillColor: color,
                        fillOpacity: 0.3,
                        strokeWeight: 2,
                        editable: false
                    });
                    previewPolygon.setMap(regionPreviewMap);
                    const bounds = new google.maps.LatLngBounds();
                    coords.forEach(coord => bounds.extend(coord));
                    regionPreviewMap.fitBounds(bounds);
                }
            }

            function validateRegionForm() {
                const isValid = elements.regionNameInput.value.trim() !== '' && selectedPolygon && selectedPolygon.getPath().getLength() > 2;
                elements.regionNameInput.classList.toggle('invalid-field', !elements.regionNameInput.value.trim());
                return isValid;
            }

            async function saveRegion() {
                if (!validateRegionForm()) {
                    showNotification('Error', 'Please provide a region name and ensure a valid region is drawn.');
                    return;
                }

                const coordinates = selectedPolygon.getPath().getArray().map(latLng => ({
                    lat: latLng.lat(),
                    lng: latLng.lng()
                }));

                const selectedDays = Array.from(elements.dayCheckboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);

                const region = {
                    name: sanitizeInput(elements.regionNameInput.value.trim()),
                    notes: sanitizeInput(elements.regionNotesInput.value.trim()),
                    coordinates,
                    transporterEmail: selectedTransporter.email || null,
                    transporterUid: selectedTransporter.uid || null,
                    status: elements.regionStatusSelect.value,
                    schedule: selectedDays.length > 0 ? {
                        startTime: elements.startTimeInput.value || null,
                        endTime: elements.endTimeInput.value || null,
                        days: selectedDays
                    } : null,
                    updatedAt: Date.now()
                };

                if (!currentRegionId) {
                    region.createdAt = Date.now();
                }

                const regionRef = currentRegionId ? ref(db, `regions/${currentRegionId}`) : push(ref(db, 'regions'));
                try {
                    await set(regionRef, region);
                    if (selectedTransporter.uid) {
                        await updateTransporterAssignment(selectedTransporter.uid, regionRef.key, true);
                    }
                    selectedPolygon.regionId = regionRef.key;
                    selectedPolygon.setOptions({ editable: false });
                    showNotification('Success', `Region "${region.name}" saved successfully`);
                    resetRegionForm();
                    hideModal('regionModal');
                    drawRegions();
                } catch (error) {
                    console.error('Save region error:', error);
                    showNotification('Error', `Failed to save region: ${error.message}`);
                }
            }

            function viewRegionDetails(regionId) {
                const region = regions.find(r => r.id === regionId);
                if (!region) return;

                document.getElementById('regionDetailsTitle').textContent = region.regionName;
                document.getElementById('regionDetailsTitle').dataset.regionId = regionId;
                document.getElementById('detailRegionName').textContent = region.regionName;
                document.getElementById('detailAssigned').textContent = region.transporterEmail || 'Unassigned';
                document.getElementById('detailStatus').textContent = region.status.replace('_', ' ');
                document.getElementById('detailSchedule').textContent = region.schedule && region.schedule.days ? formatSchedule(region.schedule) : 'Not set';
                document.getElementById('detailNotes').textContent = region.notes || 'No notes';

                detailMap = new google.maps.Map(document.getElementById('detailMap'), {
                    center: { lat: 13.1005, lng: 77.5890 },
                    zoom: 12,
                    mapTypeId: 'roadmap'
                });

                const statusColors = {
                    'unassigned': '#FF0000',
                    'assigned': '#28a745',
                    'in_progress': '#FFC107',
                    'completed': '#007bff'
                };
                const color = statusColors[region.status] || '#FF0000';
                if (region.coordinates.length > 0) {
                    const coords = region.coordinates.map(c => ({ lat: c.lat, lng: c.lng }));
                    const polygon = new google.maps.Polygon({
                        paths: coords,
                        strokeColor: color,
                        fillColor: color,
                        fillOpacity: 0.3,
                        strokeWeight: 2,
                        editable: false
                    });
                    polygon.setMap(detailMap);
                    const bounds = new google.maps.LatLngBounds();
                    coords.forEach(coord => bounds.extend(coord));
                    detailMap.fitBounds(bounds);
                }

                showModal('regionDetailsModal');
            }

            function editRegion(regionId) {
                const region = regions.find(r => r.id === regionId);
                if (!region) {
                    showNotification('Error', 'Region not found.');
                    return;
                }

                resetRegionForm();
                document.getElementById('regionModalTitle').textContent = 'Edit Region';
                document.getElementById('regionId').value = regionId;
                elements.regionNameInput.value = region.regionName;
                elements.regionStatusSelect.value = region.status;
                elements.startTimeInput.value = region.schedule && region.schedule.startTime || '';
                elements.endTimeInput.value = region.schedule && region.schedule.endTime || '';
                elements.regionNotesInput.value = region.notes || '';
                selectedTransporter = { email: region.transporterEmail, uid: region.transporterUid };
                elements.transporterSearchModal.value = region.transporterEmail || '';
                elements.dayCheckboxes.forEach(checkbox => {
                    checkbox.checked = region.schedule && region.schedule.days?.includes(checkbox.value) || false;
                });
                currentRegionId = regionId;

                selectedPolygon = drawnRegions.find(p => p.regionId === regionId);
                if (!selectedPolygon) {
                    const coords = region.coordinates.map(c => ({ lat: c.lat, lng: c.lng }));
                    selectedPolygon = new google.maps.Polygon({
                        paths: coords,
                        strokeColor: '#FF6F00',
                        fillColor: '#FF6F00',
                        fillOpacity: 0.3,
                        strokeWeight: 2,
                        editable: true,
                        clickable: true,
                        regionId: regionId
                    });
                    selectedPolygon.setMap(map);
                    drawnRegions.push(selectedPolygon);
                } else {
                    selectedPolygon.setOptions({ editable: true, strokeColor: '#FF6F00', fillColor: '#FF6F00' });
                }

                drawnRegions.forEach(p => {
                    if (p !== selectedPolygon) {
                        p.setOptions({ editable: false, strokeColor: p.strokeColor || '#FF0000', fillColor: p.fillColor || '#FF0000' });
                    }
                });

                const path = selectedPolygon.getPath();
                google.maps.event.clearInstanceListeners(path);
                google.maps.event.addListener(path, 'set_at', updateRegionPreviewMap);
                google.maps.event.addListener(path, 'insert_at', updateRegionPreviewMap);
                google.maps.event.addListener(path, 'remove_at', updateRegionPreviewMap);

                const bounds = new google.maps.LatLngBounds();
                selectedPolygon.getPath().getArray().forEach(latLng => bounds.extend(latLng));
                map.fitBounds(bounds);

                initRegionPreviewMap();
                updateRegionPreviewMap();
                showModal('regionModal');
                elements.saveRegionBtn.disabled = false;
                elements.editRegionBtn.disabled = false;
                elements.editRegionBtnModal.disabled = false;
                showNotification('Info', 'You can edit the region’s points on the map by dragging vertices or clicking edges to add new points.');
            }

            function zoomToRegion() {
                const regionId = document.getElementById('regionDetailsTitle').dataset.regionId;
                const region = regions.find(r => r.id === regionId);
                if (!region || region.coordinates.length === 0) return;

                const bounds = new google.maps.LatLngBounds();
                region.coordinates.forEach(c => bounds.extend({ lat: c.lat, lng: c.lng }));
                map.fitBounds(bounds);
                hideModal('regionDetailsModal');
            }

            function showAssignModal(regionId, regionName) {
                currentRegionId = regionId;
                document.getElementById('assignRegionName').textContent = regionName;
                document.getElementById('assignRegionId').value = regionId;
                elements.transporterSearch.value = '';
                selectedTransporter = { email: null, uid: null };
                populateTransportersInAssignModal();
                showModal('assignModal');
            }

            async function assignRegionToTransporter() {
                if (!currentRegionId || !selectedTransporter.uid) {
                    showNotification('Error', 'Please select a transporter');
                    return;
                }
                const regionRef = ref(db, `regions/${currentRegionId}`);
                try {
                    await update(regionRef, {
                        transporterEmail: selectedTransporter.email,
                        transporterUid: selectedTransporter.uid,
                        status: 'assigned'
                    });
                    await updateTransporterAssignment(selectedTransporter.uid, currentRegionId, true);
                    showNotification('Success', 'Region assigned successfully');
                    hideModal('assignModal');
                } catch (error) {
                    console.error('Assign region error:', error);
                    showNotification('Error', `Failed to assign region: ${error.message}`);
                }
            }

            async function deleteRegion(regionId) {
                if (!confirm('Are you sure you want to delete this region?')) return;

                const regionRef = ref(db, `regions/${regionId}`);
                try {
                    const snapshot = await get(regionRef);
                    const region = snapshot.val();
                    await remove(regionRef);
                    if (region.transporterUid) {
                        await updateTransporterAssignment(region.transporterUid, regionId, false);
                    }
                    showNotification('Success', 'Region deleted successfully');
                    selectPolygon(null);
                } catch (error) {
                    console.error('Delete region error:', error);
                    showNotification('Error', `Failed to delete region: ${error.message}`);
                }
            }

            async function updateTransporterAssignment(transporterUid, regionId, isAdding) {
                const transporterRef = ref(db, `transporters/${transporterUid}/assignedRegions`);
                try {
                    const snapshot = await get(transporterRef);
                    let assignedRegions = snapshot.val() || {};
                    if (isAdding) {
                        assignedRegions[regionId] = true;
                    } else {
                        delete assignedRegions[regionId];
                    }
                    await set(transporterRef, Object.keys(assignedRegions).length > 0 ? assignedRegions : null);
                } catch (error) {
                    console.error('Update transporter assignment error:', error);
                    showNotification('Error', `Error updating transporter assignment: ${error.message}`);
                }
            }

            function showModal(modalId) {
                const modalEl = document.getElementById(modalId);
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                } else {
                    console.error(`Modal ${modalId} not found`);
                }
            }

            function hideModal(modalId) {
                const modalEl = document.getElementById(modalId);
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) {
                        modal.hide();
                        if (selectedPolygon) {
                            selectedPolygon.setOptions({ editable: false });
                            const path = selectedPolygon.getPath();
                            google.maps.event.clearInstanceListeners(path);
                            if (!selectedPolygon.regionId) {
                                selectedPolygon.setMap(null);
                                selectedPolygon = null;
                            }
                        }
                    }
                } else {
                    console.error(`Modal ${modalId} not found`);
                }
            }

            function showNotification(title, message) {
                document.getElementById('toastTitle').textContent = title;
                document.getElementById('toastMessage').textContent = message;
                const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
                toast.show();
            }

            function showLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'block';
            }

            function hideLoadingSpinner() {
                document.getElementById('loadingSpinner').style.display = 'none';
            }

            function formatSchedule(schedule) {
                if (!schedule || !schedule.days) return 'Not set';
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const selectedDays = schedule.days.map(d => days[parseInt(d)]);
                return `${selectedDays.join(', ')} ${schedule.startTime || ''} - ${schedule.endTime || ''}`;
            }

            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            async function init() {
                try {
                    showLoadingSpinner();
                    if (!window.apiKeys || !window.apiKeys.firebase || !window.apiKeys.GOOGLE_MAPS_API_KEY) {
                        showNotification('Error', 'API keys are missing or invalid. Check apikeys.js.');
                        hideLoadingSpinner();
                        return;
                    }
                    loadGoogleMapsAPI();
                } catch (error) {
                    console.error('Initialization error:', error);
                    showNotification('Error', 'Failed to initialize application.');
                    hideLoadingSpinner();
                }
            }

            function setupEventListeners() {
                elements.addRegionBtn.addEventListener('click', () => {
                    resetRegionForm();
                    showNotification('Info', 'Click "Draw" and draw on the map to start.');
                });

                elements.drawRegionBtn.addEventListener('click', () => {
                    if (drawingManager) {
                        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
                        resetRegionForm();
                        showNotification('Info', 'Click on the map to start drawing a region. Double-click to finish.');
                    } else {
                        showNotification('Error', 'Drawing tools not initialized. Please refresh.');
                    }
                });

                elements.editRegionBtn.addEventListener('click', () => {
                    if (selectedPolygon && selectedPolygon.regionId) {
                        editRegion(selectedPolygon.regionId);
                    } else {
                        showNotification('Warning', 'Please select a region to edit.');
                    }
                });

                elements.editRegionBtnModal.addEventListener('click', () => {
                    const regionId = document.getElementById('regionDetailsTitle').dataset.regionId;
                    if (regionId) {
                        const polygon = drawnRegions.find(p => p.regionId === regionId);
                        if (polygon) selectPolygon(polygon);
                        editRegion(regionId);
                        hideModal('regionDetailsModal');
                    } else {
                        showNotification('Warning', 'No region selected for editing.');
                    }
                });

                elements.clearDrawingBtn.addEventListener('click', () => {
                    if (selectedPolygon && !selectedPolygon.regionId) {
                        selectedPolygon.setMap(null);
                        selectedPolygon = null;
                        resetRegionForm();
                        showNotification('Success', 'Drawing cleared');
                    } else {
                        showNotification('Warning', 'No active drawing to clear.');
                    }
                });

                elements.saveRegionBtn.addEventListener('click', saveRegion);
                elements.clearRegionFormBtn.addEventListener('click', resetRegionForm);
                elements.regionFilter.addEventListener('input', debounce(filterRegions, 300));
                elements.sortRegionName.addEventListener('click', () => sortRegions('regionName'));
                elements.sortAssignedTo.addEventListener('click', () => sortRegions('assignedTo'));
                elements.sortSchedule.addEventListener('click', () => sortRegions('schedule'));
                elements.sortStatus.addEventListener('click', () => sortRegions('status'));
                elements.confirmAssignBtn.addEventListener('click', assignRegionToTransporter);
                elements.zoomToRegionBtn.addEventListener('click', zoomToRegion);
                elements.streetLayerBtn.addEventListener('click', () => {
                    setMapLayer('roadmap');
                    elements.streetLayerBtn.classList.add('active');
                    elements.streetLayerBtn.setAttribute('aria-pressed', 'true');
                    elements.satelliteLayerBtn.classList.remove('active');
                    elements.satelliteLayerBtn.setAttribute('aria-pressed', 'false');
                });
                elements.satelliteLayerBtn.addEventListener('click', () => {
                    setMapLayer('satellite');
                    elements.satelliteLayerBtn.classList.add('active');
                    elements.satelliteLayerBtn.setAttribute('aria-pressed', 'true');
                    elements.streetLayerBtn.classList.remove('active');
                    elements.streetLayerBtn.setAttribute('aria-pressed', 'false');
                });
                elements.transporterSearchModal.addEventListener('input', debounceSearchModal);
                elements.transporterSearch.addEventListener('input', debounceSearchAssign);

                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            }

            document.addEventListener('DOMContentLoaded', () => {
                showLoadingSpinner();
                init();
                setupEventListeners();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                    } else {
                        signInAnonymously(auth)
                            .then(() => {
                                console.log('Signed in anonymously');
                                showNotification('Success', 'Signed in anonymously.');
                            })
                            .catch((error) => {
                                console.error('Sign-in error:', error);
                                showNotification('Error', `Failed to sign in: ${error.message}`);
                                hideLoadingSpinner();
                            });
                    }
                });

                async function loadNavigationAndInitializeLogout() {
                    try {
                        let attempts = 0;
                        let response;
                        while (attempts < 3) {
                            try {
                                response = await fetch('/assets/templates/adminnav.html');
                                if (response.ok) break;
                                throw new Error(`HTTP error! status: ${response.status}`);
                            } catch (error) {
                                attempts++;
                                if (attempts === 3) throw error;
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                        const html = await response.text();
                        const navContainer = document.getElementById('admin-nav-container');
                        navContainer.innerHTML = html;

                        const script = document.createElement('script');
                        script.type = 'module';
                        script.src = '/assets/js/logout-ui.js';
                        script.async = true;
                        document.body.appendChild(script);

                        let logoutButton = document.getElementById('logout-link') ||
                                          document.querySelector('a[href*="/login.html"]') ||
                                          document.querySelector('.logout-btn');
                        attempts = 0;
                        while (!logoutButton && attempts < 50) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            logoutButton = document.getElementById('logout-link') ||
                                           document.querySelector('a[href*="/login.html"]') ||
                                           document.querySelector('.logout-btn');
                            attempts++;
                        }

                        if (!logoutButton) {
                            console.warn('Logout button not found. Adding fallback navigation with logout button.');
                            showNotification('Warning', 'Logout button not found. Using fallback navigation.');
                            navContainer.innerHTML = `
                                <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                                    <div class="container-fluid">
                                        <a class="navbar-brand" href="#">BinXZer0</a>
                                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                                            <span class="navbar-toggler-icon"></span>
                                        </button>
                                        <div class="collapse navbar-collapse" id="navbarNav">
                                            <ul class="navbar-nav ms-auto">
                                                <li class="nav-item">
                                                    <a class="nav-link" id="logout-link" href="/login.html"><i class="fas fa-sign-out-alt me-1"></i>Logout</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </nav>
                            `;
                        }
                    } catch (error) {
                        console.error('Error loading navigation:', error);
                        const navContainer = document.getElementById('admin-nav-container');
                        navContainer.innerHTML = `
                            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                                <div class="container-fluid">
                                    <a class="navbar-brand" href="#">BinXZer0</a>
                                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                                        <span class="navbar-toggler-icon"></span>
                                    </button>
                                    <div class="collapse navbar-collapse" id="navbarNav">
                                        <ul class="navbar-nav ms-auto">
                                            <li class="nav-item">
                                                <a class="nav-link" id="logout-link" href="/pages/login.html"><i class="fas fa-sign-out-alt me-1"></i>Logout</a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </nav>
                        `;
                        showNotification('Error', 'Navigation failed to load. Using fallback navigation.');
                    }
                }

                fetch('/assets/templates/bottomnav.html')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to load bottom-nav.html');
                        return response.text();
                    })
                    .then(html => {
                        document.getElementById('bottom-nav').innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error loading footer:', error);
                        document.getElementById('bottom-nav').innerHTML = '<footer class="bg-dark text-white text-center py-2">Error loading footer. Check file path or server.</footer>';
                        showNotification('Error', 'Footer failed to load.');
                    });

                loadNavigationAndInitializeLogout();
            });

            return { initMap };
        })();
    </script>
    <script type="module" src="/assets/js/logout-ui.js" defer></script>
</body>
</html>